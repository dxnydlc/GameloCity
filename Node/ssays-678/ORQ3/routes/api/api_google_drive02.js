
// api_google_drive02.js



var _NombreDoc = 'api_google_drive02';
const router = require('express').Router();
const {check,validationResult} = require('express-validator');
const { Op } = require("sequelize");

const dotenv = require('dotenv');
dotenv.config();
// >>>>>>>>>>>>>    SPARKPOST   >>>>>>>>>>>>>
const SparkPost = require('sparkpost')
const clientMail    = new SparkPost(process.env.SPARKPOST_SECRET);

// >>>>>>>>>>>>>    MOMENT      >>>>>>>>>>>>>
var moment = require('moment-timezone');
moment().tz("America/Lima").format();
// moment().format('YYYY-MM-DD HH:mm:ss');

// >>>>>>>>>>>>>    NEXMO       >>>>>>>>>>>>>
const Nexmo         = require('nexmo');
const BitlyClient   = require('bitly').BitlyClient;
const bitly         = new BitlyClient(process.env.BITLY_API);

// LEER EXCEL
const reader = require('xlsx');

// Modelos
const { errorLogModel } = require('../../dbA');
const { xlsLAPIncidenciasCabModel, xlsLAPIncidenciasDetModel, User, sequelize, archiGoogleModel, sucursalModel } = require('../../db');

var _fechaLatFormat = "%d/%m/%Y %H:%i",_fechaONlyLatFormat = "%d/%m/%Y";


//googleapis
const {google} = require('googleapis');
const readline   = require('readline');
const { GoogleAuth } = require("google-auth-library");
const {Storage} = require('@google-cloud/storage');

//path module
const path = require('path');

//file system module
const fs = require('fs');

//client id
const CLIENT_ID = '804818106010-mtutcsfj86qmmlqvvmtsqc74hmc3bmvh.apps.googleusercontent.com'

//client secret
const CLIENT_SECRET = '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';

//redirect URL
const REDIRECT_URI = 'https://developers.google.com/oauthplayground';

//refresh token
const REFRESH_TOKEN = 'YOUR REFRESH TOKEN';

//intialize auth client
const oauth2Client = new google.auth.OAuth2(
    CLIENT_ID,
    CLIENT_SECRET,
    REDIRECT_URI
);


//setting our auth credentials
oauth2Client.setCredentials({ refresh_token: REFRESH_TOKEN });


//initialize google drive
const drive = google.drive({
    version: 'v3',
    auth: oauth2Client,
});


//file path for out file
const filePath = path.join(__dirname, 'filename.format');

//`${_RUTA_PROYECTO}adjuntos/reporte_lap/IMG_20220514_151213.jpg`

// RUTAS
const _RUTA_PROYECTO = process.env.RUTA_PROYECTO;

// IdCli 111273270134676021407

//const keysEnvVa = `${_RUTA_PROYECTO}config/ssays-orquesta-252414-5c215e3967d2.json`
const keyFilename 	= `${_RUTA_PROYECTO}config/buspro2019-3f45038e33af.json`;
const KEYFILEPATH = keyFilename;


const SCOPES =  [ 'https://www.googleapis.com/auth/drive' ];

const auth = new GoogleAuth( KEYFILEPATH , SCOPES );

/*const auth = new google.auth.GoogleAuth({
    keyFilename : KEYFILEPATH ,
    scopes      : SCOPES
});*/

async function crearySubirFile( auth )
{
    //
    const driveService = google.drive({ version: 'v3' , auth });

    let fileMetaData = {
        name : 'imagen.png',
        parents : [ '1JsWO7b5epVvbR3atJ6UaoSY7-HY27hKC' ]
    }

    let media = {
        mimetype : 'image/png' ,
        body : fs.createReadStream( `${_RUTA_PROYECTO}adjuntos/reporte_lap/IMG_20220514_151213.jpg` )
    };

    let response = await driveService.files.create({
        resource : fileMetaData ,
        media : media ,
        fields : 'id'
    });

    varDump( response );

}


// -------------------------------------------------------------
//////////////////////////////////////////////////////////
//                  CARGAR DOCUMENTO                    //
//////////////////////////////////////////////////////////
router.post('/subir01', async (req,res)=>{
    // uuid
    var _response = {};
    _response.codigo = 200;

    varDump( KEYFILEPATH );

    _response.locales = [];
    _response.data    = [];
    _response.files   = [];

    try {
        const storage = new Storage();
        
        const results = await storage.getBuckets();

        const [buckets] = results;

        console.log('Buckets:');
        buckets.forEach(bucket => {
        console.log(bucket.name);
        });

        _response.resp = { 'titulo' : `Correcto` , 'clase' : `info` , 'texto' : `Archivo subido.` };
        //
    } catch (error) {
        varDump( error );
        _response.codigo = 500;
        _response.resp = { 'titulo' : `Error` , 'clase' : `error` , 'texto' :  `Error: ${error}.` };
    }

    return res.status(_response.codigo).json( _response );
    //
});
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
// -------------------------------------------------------------
function varDump( _t )
{
    console.log( _t );
}
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
module.exports = router;
// -------------------------------------------------------------